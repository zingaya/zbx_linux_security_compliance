# Zabbix and Ansible security and compliance

## About

This script was first intended to be as a patch management tool for Linux (for both yum and apt package managers), but added some extra items to keep track if is it compliant within the approved Linux distribtions for the company and kernel deprecation. 

It does not require that all hosts have a Zabbix agent installed, but you need to have the host in the Zabbix with the template "Linux - Security and compliance" that has the items and triggers needed. Also, there is an extra template that only contains a single item to "Linux - Security and compliance"

The ansible playbook already define "all" as the hosts group on the inventory. You should setup you own inventory file and adapt those as needed.

Designed for Zabbix 6.4 and above.

## Files

- ansible_linux_security_compliance.yaml: Ansible playbook
- zbx_linux_security_compliance: Python script
- zbx_linux_security_compliance.yaml: Zabbix templates
- No Ansible hosts inventory provided
- discover.sh: Sh script to discover hosts with SSH open port and create Ansible like inventory file

## About the script

This script automates the execution of an Ansible playbook for Linux security compliance checks and reports the results to a Zabbix server. The script performs the following tasks:

- Generates an Ansible Playbook: Creates a temporary Ansible playbook based on a template with optional parameters.
- Runs the Ansible Playbook: Executes the generated playbook on the specified inventory.
- Processes JSON Output: Reads and processes JSON files generated by the playbook to extract relevant data.
- Sends Data to Zabbix: Sends the extracted data and Ansible logs to a Zabbix server for monitoring and reporting.

## Prerequisites

Before running the script, ensure the following:

- Ansible and ansible-runner: Install Ansible and ansible-runner on the system where the script will run.
- Zabbix Sender Library: Install the custom Zabbix Sender library (zabbix_utils).
- Python Dependencies: Ensure Python 3 and required libraries are installed (argparse, shutil, json, re, os).
- Ansible Playbook and Inventory: Provide paths to the Ansible playbook template and inventory file.
- Zabbix Server Details: Configure the Zabbix server IP address and port.

Install required Python libraries:

    pip install ansible ansible-runner argparse shutil json re os zabbix-utils

Install required Ansible collection:

    ansible-galaxy collection install community.general

Configure Script Parameters:

- Edit the script to set the PLAYBOOK_PATH, INVENTORY_PATH, ZABBIX_SERVER, and ZABBIX_PORT variables.
- Optionally set the default Zabbix hostname for logs and results.

## Usage

The script supports the following command-line arguments:

    --playbook_template: Path to the Ansible playbook template (default: configured PLAYBOOK_PATH).
    --inventory: Path to the Ansible inventory file (default: configured INVENTORY_PATH).
    --limit: Limit the execution to a specific group or host. (default: all).
    --upgrade: Set apt/yum upgrade parameter (yes or no, default: no).
    --sshcheck: Set ANSIBLE_HOST_KEY_CHECKING (true or false, default: true).
    --lockstate: Set packages to lock/hold or unlock/unhold (lock or unlock).
    --lockpackages: Which packages to lock/hold or unlock/unhold. Use along with --lockstate.
    --become: Escalate privileges (yes or no) Default: no.

Note on locking packages: For some versions of yum I noticed that it does not work with wildcards. Try to use the exact name of the packages you need to lock.

## To do

- ~~Add parameters to exclude packages to check and upgrade~~
- Use the Zabbix API to verify if the host exists, and if not, create it. Or create new items into zabbix_def_hostname (with Zabbix API, or LLD)
- Include checks to get (some may require Zabbix agent):
  - SELinux status
  - Firewall status
  - List of opened ports
  - Users logged in
  - Log audit
  - Autorized processes
  - /var/run/reboot-required
  - /etc/group (new groups, or users assigned to root or sudo groups)
  - /etc/passwd (already in Zabbix default template, maybe check for new users)
- Improve triggers using Zabbix 7.0
- Add option to: Apt full-upgrade/Yum distro-sync
- Add Dnf and Apk modules
- Change to ansible_facts['pkg_mgr'] instead of ansible_facts['distribution']
- Simplify lock/unlock package arguments
- Use module async_status to handle parallel apt/yum/dnf/apk update/upgrade
- On fail to lock packages, send/update list in Zabbix
- Add ability to run this script more than once