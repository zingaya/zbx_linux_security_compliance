# Linux Security Compliance and patch Management with Ansible and Zabbix

## Overwiew

This repository contains a Python script to manage Linux security compliance using Ansible. The script allows you to handle updates, lock/unlock packages, and send the results to a Zabbix server for monitoring. The configuration can be customized via command-line arguments.

Extra items provided in the Zabbix template to track whether Linux distributions comply with company policy/standard practices and kernel deprecation status.

It does not require that all hosts have a Zabbix agent installed, but you need to have the host in Zabbix with the template "Linux - Security and compliance" that has the items and triggers needed.\
Additionally, template "Linux - Security and compliance - ansible log" only contains a single item to trap logs sent from this script. It could be added into the same host from where this script is executed (usually a jump server).

## Files included

- zbx_linux_security_compliance: Python script
- zbx_linux_security_compliance.yaml: Zabbix templates
- No Ansible hosts inventory provided
- discover.sh: Sh script to discover hosts with SSH open port and create Ansible inventory file

## About the script

This script generates and Ansible playbook and reports the results to a Zabbix server. The script performs the following tasks:

- Generates an Ansible Playbook: Creates a temporary Ansible playbook based on a embbeded and modular JSON.
- Runs the Ansible Playbook: Executes the playbook and writes a JSON file for each host.
- Processes JSON files: Reads and processes JSON files generated by the previous step to extract relevant data.
- Sends Data to Zabbix: Sends the extracted data and Ansible output to a Zabbix server.

Ansible connects to each host using SSH keys. Hosts must have SSH pub key in the ~/.ssh/authorized_hosts file.

## Prerequisites

- SSH key pair
- Ansible 2.9+
- Python 3.9+
- Zabbix 6.4+

Install required Python libraries:

    pip install ansible ansible-runner argparse shutil json re os zabbix-utils pyyaml

Install required Ansible collection:

    ansible-galaxy collection install community.general

## Usage

Configure script parameters to set the INVENTORY_PATH, ZABBIX_SERVER, ZABBIX_PORT, ZABBBIX_HOST variables. Can be overriden via arguments too.

The script supports the following command-line arguments:

    --inventory: Path to the Ansible inventory file (default: /etc/ansible/hosts).
    --zabbix-server: Zabbix server IP/FQDN.
    --zabbix-port: Zabbix server port (default: 10051).
    --zabbix-host: Host in Zabbix.
    --limit: Limit the execution to a specific group or host. (default: all).
    --upgrade: Set upgrade flag (default: no).
    --ignore-sshcheck: Ignore SSH host key checking. Same as 'ssh -o StrictHostKeyChecking=no' (default: true)
    --become: Escalate privileges (default: no).
    --debug: Output some extra details. Playbook YAML, JSON sent to Zabbix, and variable current values.
    --package-manager: Sets a list of package manager (default: ["YUM", "APT"]).
    --lock-packages: Marks packages to be "on hold" or "lock" and avoid accidental upgrades. Use --unlock-packages to remove the mark.

## To do

- Use the Zabbix API to verify if the host exists, and if not, create it. Or create new items into zabbix_def_hostname (with Zabbix API, or LLD).
- Include checks to get (some may require Zabbix agent):
  - SELinux status
  - Firewall status
  - List of opened ports
  - Users logged in
  - Log audit
  - Autorized processes
  - /var/run/reboot-required
- Improved triggers using Zabbix 7.0+
- Implement a "dry-run" (ansible --check-mode)