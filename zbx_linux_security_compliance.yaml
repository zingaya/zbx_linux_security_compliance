zabbix_export:
  version: '6.4'
  template_groups:
    - uuid: 26f42bba0c4448c290fa5423bb4a2664
      name: 'Custom Templates'
  templates:
    - uuid: f15c98400e5f47398a27d1c68b84627f
      template: 'Linux - Security and compliance'
      name: 'Linux - Security and compliance'
      groups:
        - name: 'Custom Templates'
      items:
        - uuid: 5498d4f5c34345c18854a84702760464
          name: 'Linux distribution'
          type: DEPENDENT
          key: os.distribution
          history: 30d
          value_type: CHAR
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..distro.first()
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: updates.raw
          tags:
            - tag: component
              value: compliance
            - tag: component
              value: os-distribution
        - uuid: 226341b98d594c02a3f4545a096a30dc
          name: 'Linux distribution version'
          type: DEPENDENT
          key: os.distribution_ver
          history: 30d
          value_type: FLOAT
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..distro_ver.first()
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: updates.raw
          tags:
            - tag: component
              value: compliance
            - tag: component
              value: os-distribution
        - uuid: 6c59bb32cfd0424286357ff71dd0b70c
          name: 'Linux kernel'
          type: DEPENDENT
          key: os.kernel
          history: 30d
          value_type: CHAR
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..kernel.first()
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: updates.raw
          tags:
            - tag: component
              value: compliance
            - tag: component
              value: os-kernel
          triggers:
            - uuid: bcda906fa93b4e608aa40d8e1101a3fc
              expression: 'find(/Linux - Security and compliance/os.kernel,,"iregexp","{$KERNEL.DEPRECATED}")=1'
              name: 'Linux kernel deprecated'
              opdata: 'Kernel: {ITEM.LASTVALUE1}'
              priority: WARNING
              tags:
                - tag: scope
                  value: security
        - uuid: ad65878915a04c479226b3377580f996
          name: 'Pending updates'
          type: DEPENDENT
          key: updates.pending
          preprocessing:
            - type: JSONPATH
              parameters:
                - $..updates.first()
              error_handler: CUSTOM_VALUE
              error_handler_params: '9999'
            - type: JSONPATH
              parameters:
                - $..name.length()
              error_handler: CUSTOM_VALUE
              error_handler_params: '9999'
          master_item:
            key: updates.raw
          tags:
            - tag: component
              value: security
            - tag: component
              value: updates
          triggers:
            - uuid: e36f6833042c4c1f8449d781cf7717ca
              expression: 'last(/Linux - Security and compliance/updates.pending)=9999'
              name: 'Error when retrieving updates'
              priority: WARNING
              tags:
                - tag: scope
                  value: security
            - uuid: 76680ea2326b4f698727861d1107a2d9
              expression: |
                nodata(/Linux - Security and compliance/updates.pending,1w)=1
                or
                count(/Linux - Security and compliance/updates.pending,1w)=0
              name: 'No new audit data since 1 week'
              priority: WARNING
              description: |
                Check if the script was successfully executed in this host.
                Make sure at least, the script runs once per week, in order to maintain an updated status of this host.
              tags:
                - tag: scope
                  value: compliance
                - tag: scope
                  value: security
            - uuid: ac79dd0531f746b4be6571f24197d70f
              expression: 'last(/Linux - Security and compliance/updates.pending)>0'
              name: 'Pending updates'
              opdata: 'Pending: {ITEM.LASTVALUE1}'
              priority: INFO
              dependencies:
                - name: 'Error when retrieving updates'
                  expression: 'last(/Linux - Security and compliance/updates.pending)=9999'
              tags:
                - tag: scope
                  value: security
        - uuid: f5dd53a4d9eb4c799c5dbde7c7636b49
          name: 'Pending updates (list)'
          type: DEPENDENT
          key: updates.pending.list
          history: 30d
          value_type: TEXT
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var obj = JSON.parse(value);
                  names = '';
                  var updates = obj[0].updates;
                  if (typeof updates === 'string') {return updates}
                  else {
                      for (var i = 0; i < updates.length; i++) {
                          var name = updates[i].name;
                          names += name + '\n';
                      }
                      return names;
                  };                  
          master_item:
            key: updates.raw
          tags:
            - tag: component
              value: security
            - tag: component
              value: updates
        - uuid: 8a9723bd6e004cc89245e8d79241c860
          name: 'Get updates'
          type: TRAP
          key: updates.raw
          history: '0'
          value_type: TEXT
          tags:
            - tag: component
              value: raw
      macros:
        - macro: '{$KERNEL.DEPRECATED}'
          value: '^[4]\.(1[0-4]|[0-9](?![0-9]))|^[1-3]\.[0-9]'
          description: 'Deprecated kernel regex'
    - uuid: 65d5cdc6b2ff4b5eb064d3683ef4ffd5
      template: 'Linux - Security and compliance - ansible log'
      name: 'Linux - Security and compliance - ansible log'
      description: |
        This template contains only the item to get the ansible playbook execution log
        Modify the zabbix_def_hostname in the python script to match the host where you assigned the template.
      groups:
        - name: 'Custom Templates'
      items:
        - uuid: 38e27d1975cd44eba30a4685d3f50e21
          name: 'Ansible result'
          type: TRAP
          key: ansible.result
          value_type: TEXT
          description: 'Keep track of execution logs of the ansible playbook'
          tags:
            - tag: component
              value: ansible-log
  triggers:
    - uuid: 084c8c341daa4521929838aa22ec826e
      expression: |
        last(/Linux - Security and compliance/os.distribution)="AlmaLinux"
        and
        last(/Linux - Security and compliance/os.distribution_ver)<8
        or
        last(/Linux - Security and compliance/os.distribution)="Debian"
        and
        last(/Linux - Security and compliance/os.distribution_ver)<12
      name: 'Linux distribution is not compliant'
      opdata: 'Distro: {ITEM.LASTVALUE1} {ITEM.LASTVALUE2}'
      priority: INFO
      tags:
        - tag: scope
          value: compliance
